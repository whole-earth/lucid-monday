"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("three"),t=require("./shaderMaterial.cjs.js");function n(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var r=n(e);const o=t.shaderMaterial({alphaTest:0,viewport:new r.Vector2(1980,1080),focal:1e3,centerAndScaleTexture:null,covAndColorTexture:null},"\n    precision highp sampler2D;\n    precision highp usampler2D;\n    out vec4 vColor;\n    out vec3 vPosition;\n    uniform vec2 resolution;\n    uniform vec2 viewport;\n    uniform float focal;\n    attribute uint splatIndex;\n    uniform sampler2D centerAndScaleTexture;\n    uniform usampler2D covAndColorTexture;    \n\n    vec2 unpackInt16(in uint value) {\n      int v = int(value);\n      int v0 = v >> 16;\n      int v1 = (v & 0xFFFF);\n      if((v & 0x8000) != 0)\n        v1 |= 0xFFFF0000;\n      return vec2(float(v1), float(v0));\n    }\n\n    void main () {\n      ivec2 texSize = textureSize(centerAndScaleTexture, 0);\n      ivec2 texPos = ivec2(splatIndex%uint(texSize.x), splatIndex/uint(texSize.x));\n      vec4 centerAndScaleData = texelFetch(centerAndScaleTexture, texPos, 0);\n      vec4 center = vec4(centerAndScaleData.xyz, 1);\n      vec4 camspace = modelViewMatrix * center;\n      vec4 pos2d = projectionMatrix * camspace;\n\n      float bounds = 1.2 * pos2d.w;\n      if (pos2d.z < -pos2d.w || pos2d.x < -bounds || pos2d.x > bounds\n        || pos2d.y < -bounds || pos2d.y > bounds) {\n        gl_Position = vec4(0.0, 0.0, 2.0, 1.0);\n        return;\n      }\n\n      uvec4 covAndColorData = texelFetch(covAndColorTexture, texPos, 0);\n      vec2 cov3D_M11_M12 = unpackInt16(covAndColorData.x) * centerAndScaleData.w;\n      vec2 cov3D_M13_M22 = unpackInt16(covAndColorData.y) * centerAndScaleData.w;\n      vec2 cov3D_M23_M33 = unpackInt16(covAndColorData.z) * centerAndScaleData.w;\n      mat3 Vrk = mat3(\n        cov3D_M11_M12.x, cov3D_M11_M12.y, cov3D_M13_M22.x,\n        cov3D_M11_M12.y, cov3D_M13_M22.y, cov3D_M23_M33.x,\n        cov3D_M13_M22.x, cov3D_M23_M33.x, cov3D_M23_M33.y\n      );\n\n      mat3 J = mat3(\n        focal / camspace.z, 0., -(focal * camspace.x) / (camspace.z * camspace.z),\n        0., focal / camspace.z, -(focal * camspace.y) / (camspace.z * camspace.z),\n        0., 0., 0.\n      );\n\n      mat3 W = transpose(mat3(modelViewMatrix));\n      mat3 T = W * J;\n      mat3 cov = transpose(T) * Vrk * T;\n      vec2 vCenter = vec2(pos2d) / pos2d.w;\n      float diagonal1 = cov[0][0] + 0.3;\n      float offDiagonal = cov[0][1];\n      float diagonal2 = cov[1][1] + 0.3;\n      float mid = 0.5 * (diagonal1 + diagonal2);\n      float radius = length(vec2((diagonal1 - diagonal2) / 2.0, offDiagonal));\n      float lambda1 = mid + radius;\n      float lambda2 = max(mid - radius, 0.1);\n      vec2 diagonalVector = normalize(vec2(offDiagonal, lambda1 - diagonal1));\n      vec2 v1 = min(sqrt(2.0 * lambda1), 1024.0) * diagonalVector;\n      vec2 v2 = min(sqrt(2.0 * lambda2), 1024.0) * vec2(diagonalVector.y, -diagonalVector.x);\n      uint colorUint = covAndColorData.w;\n      vColor = vec4(\n        float(colorUint & uint(0xFF)) / 255.0,\n        float((colorUint >> uint(8)) & uint(0xFF)) / 255.0,\n        float((colorUint >> uint(16)) & uint(0xFF)) / 255.0,\n        float(colorUint >> uint(24)) / 255.0\n      );\n      vPosition = position;\n\n      gl_Position = vec4(\n        vCenter \n          + position.x * v2 / viewport * 2.0 \n          + position.y * v1 / viewport * 2.0, pos2d.z / pos2d.w, 1.0);\n    }\n    ",`\n    #include <alphatest_pars_fragment>\n    #include <alphahash_pars_fragment>\n    in vec4 vColor;\n    in vec3 vPosition;\n    void main () {\n      float A = -dot(vPosition.xy, vPosition.xy);\n      if (A < -4.0) discard;\n      float B = exp(A) * vColor.a;\n      vec4 diffuseColor = vec4(vColor.rgb, B);\n      #include <alphatest_fragment>\n      #include <alphahash_fragment>\n      gl_FragColor = diffuseColor;\n      #include <tonemapping_fragment>\n      #include <${parseInt(r.REVISION.replace(/\D+/g,""))>=154?"colorspace_fragment":"encodings_fragment"}>\n    }\n  `);function a(e){let t=null,n=0;e.onmessage=r=>{if("push"==r.data.method){0===n&&(t=new Float32Array(r.data.length));const e=new Float32Array(r.data.matrices);t.set(e,n),n+=e.length}else if("sort"==r.data.method&&null!==t){const n=function(e,n=!1){const r=t.length/16;let o=-1/0,a=1/0;const l=new Float32Array(r),s=new Int32Array(l.buffer),c=new Int32Array(r);let i=0;for(let s=0;s<r;s++){const r=e[0]*t[16*s+12]+e[1]*t[16*s+13]+e[2]*t[16*s+14]+e[3];(n||r<0&&t[16*s+15]>-1e-4*r)&&(l[i]=r,c[i]=s,i++,r>o&&(o=r),r<a&&(a=r))}const d=65535/(o-a),u=new Uint32Array(65536);for(let e=0;e<i;e++)s[e]=(l[e]-a)*d|0,u[s[e]]++;const f=new Uint32Array(65536);for(let e=1;e<65536;e++)f[e]=f[e-1]+u[e-1];const x=new Uint32Array(i);for(let e=0;e<i;e++)x[f[s[e]]++]=c[e];return x}(new Float32Array(r.data.view),r.data.hashed);e.postMessage({indices:n,key:r.data.key},[n.buffer])}}}class l extends r.Loader{constructor(e,t=25e3){super(),this.gl=e,this.chunkSize=t}async loadAsync(e,t,n){return new Promise((r=>this.load(e,r,t,n)))}load(e,t,n,o){const l={gl:this.gl,url:this.manager.resolveURL(e),worker:new Worker(URL.createObjectURL(new Blob(["(",a.toString(),")(self)"],{type:"application/javascript"}))),manager:this.manager,update:(e,t,n)=>function(e,t,n,r){if(e.updateMatrixWorld(),t.gl.getCurrentViewport(n.viewport),n.material.viewport.x=n.viewport.z,n.material.viewport.y=n.viewport.w,n.material.focal=n.viewport.w/2*Math.abs(e.projectionMatrix.elements[5]),n.ready){if(r&&n.sorted)return;n.ready=!1;const e=new Float32Array([n.modelViewMatrix.elements[2],-n.modelViewMatrix.elements[6],n.modelViewMatrix.elements[10],n.modelViewMatrix.elements[14]]);t.worker.postMessage({method:"sort",src:t.url,key:n.uuid,view:e.buffer,hashed:r},[e.buffer]),r&&t.loaded&&(n.sorted=!0)}}(t,l,e,n),connect:e=>function(e,t){e.loading||async function(e){e.loading=!0;let t=0,n=0;const r=[];let o=0;const a=0!==e.totalDownloadBytes;for(;;)try{const{value:l,done:c}=await e.stream.read();if(c)break;if(t+=l.length,null!=e.totalDownloadBytes){const n=t/e.totalDownloadBytes*100;if(e.onProgress&&n-o>1){const r=new ProgressEvent("progress",{lengthComputable:a,loaded:t,total:e.totalDownloadBytes});e.onProgress(r),o=n}}r.push(l);const i=t-n;if(null!=e.totalDownloadBytes&&i>e.rowLength*e.chunkSize){const t=Math.floor(i/e.rowLength),o=new Uint8Array(i);let l=0;for(const e of r)o.set(e,l),l+=e.length;if(r.length=0,i>t*e.rowLength){const n=new Uint8Array(i-t*e.rowLength);n.set(o.subarray(i-n.length,i),0),r.push(n)}const c=new Uint8Array(t*e.rowLength);c.set(o.subarray(0,c.byteLength),0);const d=s(e,c.buffer,t);if(e.worker.postMessage({method:"push",src:e.url,length:16*e.numVertices,matrices:d.buffer},[d.buffer]),n+=t*e.rowLength,e.onProgress){const t=new ProgressEvent("progress",{lengthComputable:a,loaded:e.totalDownloadBytes,total:e.totalDownloadBytes});e.onProgress(t)}}}catch(e){console.error(e);break}if(t-n>0){const t=new Uint8Array(r.reduce(((e,t)=>e+t.length),0));let n=0;for(const e of r)t.set(e,n),n+=e.length;const o=Math.floor(t.byteLength/e.rowLength),a=s(e,t.buffer,o);e.worker.postMessage({method:"push",src:e.url,length:16*o,matrices:a.buffer},[a.buffer])}e.loaded=!0,e.manager.itemEnd(e.url)}(e);t.ready=!1,t.pm=new r.Matrix4,t.vm1=new r.Matrix4,t.vm2=new r.Matrix4,t.viewport=new r.Vector4;const n=new Uint32Array(e.bufferTextureWidth*e.bufferTextureHeight),o=new r.InstancedBufferAttribute(n,1,!1);o.setUsage(r.DynamicDrawUsage);const a=t.geometry=new r.InstancedBufferGeometry,l=new Float32Array(18),c=new r.BufferAttribute(l,3);function i(e){if(t&&e.data.key===t.uuid){const n=new Uint32Array(e.data.indices);a.attributes.splatIndex.set(n),a.attributes.splatIndex.needsUpdate=!0,a.instanceCount=n.length,t.ready=!0}}async function d(){for(;;){const t=e.gl.properties.get(e.centerAndScaleTexture),n=e.gl.properties.get(e.covAndColorTexture);if(null!=t&&t.__webglTexture&&null!=n&&n.__webglTexture&&e.loadedVertexCount>0)break;await new Promise((e=>setTimeout(e,10)))}t.ready=!0}return a.setAttribute("position",c),c.setXYZ(2,-2,2,0),c.setXYZ(1,2,2,0),c.setXYZ(0,-2,-2,0),c.setXYZ(5,-2,-2,0),c.setXYZ(4,2,2,0),c.setXYZ(3,2,-2,0),c.needsUpdate=!0,a.setAttribute("splatIndex",o),a.instanceCount=1,e.worker.addEventListener("message",i),d(),()=>e.worker.removeEventListener("message",i)}(l,e),loading:!1,loaded:!1,loadedVertexCount:0,chunkSize:this.chunkSize,totalDownloadBytes:0,numVertices:0,rowLength:32,maxVertexes:0,bufferTextureWidth:0,bufferTextureHeight:0,stream:null,centerAndScaleData:null,covAndColorData:null,covAndColorTexture:null,centerAndScaleTexture:null,onProgress:n};(async function(e){e.manager.itemStart(e.url);const t=await fetch(e.url);if(null===t.body)throw"Failed to fetch file";const n=t.headers.get("Content-Length"),o=n?parseInt(n):void 0;if(null==o)throw"Failed to get content length";e.stream=t.body.getReader(),e.totalDownloadBytes=o,e.numVertices=Math.floor(e.totalDownloadBytes/e.rowLength);const a=e.gl.getContext(),l=a.getParameter(a.MAX_TEXTURE_SIZE);e.maxVertexes=l*l,e.numVertices>e.maxVertexes&&(e.numVertices=e.maxVertexes);return e.bufferTextureWidth=l,e.bufferTextureHeight=Math.floor((e.numVertices-1)/l)+1,e.centerAndScaleData=new Float32Array(e.bufferTextureWidth*e.bufferTextureHeight*4),e.covAndColorData=new Uint32Array(e.bufferTextureWidth*e.bufferTextureHeight*4),e.centerAndScaleTexture=new r.DataTexture(e.centerAndScaleData,e.bufferTextureWidth,e.bufferTextureHeight,r.RGBAFormat,r.FloatType),e.centerAndScaleTexture.needsUpdate=!0,e.covAndColorTexture=new r.DataTexture(e.covAndColorData,e.bufferTextureWidth,e.bufferTextureHeight,r.RGBAIntegerFormat,r.UnsignedIntType),e.covAndColorTexture.internalFormat="RGBA32UI",e.covAndColorTexture.needsUpdate=!0,e})(l).then(t).catch((e=>{null==o||o(e),l.manager.itemError(l.url)}))}}function s(e,t,n){const o=e.gl.getContext();if(e.loadedVertexCount+n>e.maxVertexes&&(n=e.maxVertexes-e.loadedVertexCount),n<=0)throw"Failed to parse file";const a=new Uint8Array(t),l=new Float32Array(t),s=new Float32Array(16*n),c=new Uint8Array(e.covAndColorData.buffer),i=new Int16Array(e.covAndColorData.buffer);for(let t=0;t<n;t++){const n=new r.Quaternion(-(a[32*t+28+1]-128)/128,(a[32*t+28+2]-128)/128,(a[32*t+28+3]-128)/128,-(a[32*t+28+0]-128)/128);n.invert();const o=new r.Vector3(l[8*t+0],l[8*t+1],-l[8*t+2]),d=new r.Vector3(l[8*t+3+0],l[8*t+3+1],l[8*t+3+2]),u=new r.Matrix4;u.makeRotationFromQuaternion(n),u.transpose(),u.scale(d);const f=u.clone();u.transpose(),u.premultiply(f),u.setPosition(o);const x=[0,1,2,5,6,10];let p=0;for(let e=0;e<x.length;e++)Math.abs(u.elements[x[e]])>p&&(p=Math.abs(u.elements[x[e]]));let g=4*e.loadedVertexCount+4*t;e.centerAndScaleData[g+0]=o.x,e.centerAndScaleData[g+1]=-o.y,e.centerAndScaleData[g+2]=o.z,e.centerAndScaleData[g+3]=p/32767,g=8*e.loadedVertexCount+4*t*2;for(let e=0;e<x.length;e++)i[g+e]=32767*u.elements[x[e]]/p;g=16*e.loadedVertexCount+4*(4*t+3);const h=new r.Color(a[32*t+24+0]/255,a[32*t+24+1]/255,a[32*t+24+2]/255);h.convertSRGBToLinear(),c[g+0]=255*h.r,c[g+1]=255*h.g,c[g+2]=255*h.b,c[g+3]=a[32*t+24+3],u.elements[15]=Math.max(d.x,d.y,d.z)*a[32*t+24+3]/255;for(let e=0;e<16;e++)s[16*t+e]=u.elements[e]}for(;n>0;){let t=0,r=0;const a=e.loadedVertexCount%e.bufferTextureWidth,l=Math.floor(e.loadedVertexCount/e.bufferTextureWidth);e.loadedVertexCount%e.bufferTextureWidth!=0?(t=Math.min(e.bufferTextureWidth,a+n)-a,r=1):Math.floor(n/e.bufferTextureWidth)>0?(t=e.bufferTextureWidth,r=Math.floor(n/e.bufferTextureWidth)):(t=n%e.bufferTextureWidth,r=1);const s=e.gl.properties.get(e.centerAndScaleTexture);o.bindTexture(o.TEXTURE_2D,s.__webglTexture),o.texSubImage2D(o.TEXTURE_2D,0,a,l,t,r,o.RGBA,o.FLOAT,e.centerAndScaleData,4*e.loadedVertexCount);const c=e.gl.properties.get(e.covAndColorTexture);o.bindTexture(o.TEXTURE_2D,c.__webglTexture),o.texSubImage2D(o.TEXTURE_2D,0,a,l,t,r,o.RGBA_INTEGER,o.UNSIGNED_INT,e.covAndColorData,4*e.loadedVertexCount),e.gl.resetState(),e.loadedVertexCount+=t*r,n-=t*r}return s}class c extends r.Mesh{constructor(e,t,{toneMapped:n=!1,alphaTest:a=0,alphaHash:l=!1}={}){super(),this.frustumCulled=!1,this.onBeforeRender=()=>e.update(this,t,l),this.material=new o,Object.assign(this.material,{transparent:!l,depthTest:!0,alphaTest:l?0:a,centerAndScaleTexture:e.centerAndScaleTexture,covAndColorTexture:e.covAndColorTexture,depthWrite:!!l||a>0,blending:l?r.NormalBlending:r.CustomBlending,blendSrcAlpha:r.OneFactor,alphaHash:!!l,toneMapped:n}),e.connect(this)}}exports.Splat=c,exports.SplatLoader=l;
